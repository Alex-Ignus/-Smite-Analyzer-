<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <style> 
    body {
      font-family: monospace;
    }
    .y-axis line {
      stroke: black;
    }
    .annual-growth {
      fill: black;
    }
    .bar-label,
    .x-axis {
      font-size: 8px;
    }
    .domain,
    .tick line {
      opacity: 0.5;
    }
    div.tooltip { 
      position: absolute;     
      text-align: center;     
      width: fit-content;
      height: fit-content;
      padding: 10px;     
      font: 12px sans-serif;    
      background: lightsteelblue; 
      border: 0px;    
      border-radius: 8px;     
      pointer-events: none;     
    }
    .annual-growth:hover{
      filter: grayscale(0%)!important;
    }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-firestore.js"></script>
    <script type="text/javascript">
        var firebaseConfig = {
            apiKey: "AIzaSyCQr6mE-PZzYiDwhNgCDwuDVGdDvPQ7P6M",
            authDomain: "puppyplayground.firebaseapp.com",
            projectId: "puppyplayground",
            storageBucket: "puppyplayground.appspot.com",
            messagingSenderId: "201968710980",
            appId: "1:201968710980:web:c114c4912ef98e02739311",
            measurementId: "G-SFMQ6K9778"
        };
        firebase.initializeApp(firebaseConfig);
        const smiteDB = firebase.firestore();
    </script>
</head>

<body>
  <div id="chart3">
  <svg class="container" viewBox="0 0 960 500" preserveAspectRatio="xMinYMin slice" width="100%" height="100%" style="width: 100%; overflow: hidden;"><svg width="960" height="500"></svg></svg>
  </div>
  <script type="text/javascript">

var data = {'all':[]};
smiteDB.collection('damage_test').orderBy('damage_total').get().then(res=>{
  var main = res._delegate.docs;
  for (i=0;i<main.length;i++){
    data.all[i] = {
      country: res.docs[i]._delegate._document.data.partialValue.mapValue.fields.Name.stringValue,
      annual_growth: parseInt(res.docs[i]._delegate._document.data.partialValue.mapValue.fields.damage_total.integerValue),
      damage_given: parseInt(res.docs[i]._delegate._document.data.partialValue.mapValue.fields.damage_given.integerValue),
      damage_taken: parseInt(res.docs[i]._delegate._document.data.partialValue.mapValue.fields.damage_taken.integerValue)
    }
  }
  makeChart()
})

var makeChart = ()=>{

var margin = { top: 40, right: 50, bottom: 60, left: 50 };
var width = 960 - margin.left - margin.right,
    height = 250 - margin.top - margin.bottom;

var svg = d3.select("body svg svg")
  .append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var cfg = {
  labelMargin: 5,
  xAxisMargin: 10,
  legendRightMargin: 0
};

var x = d3.scaleLinear().range([0, width]);

var colour = d3.scaleQuantize().domain([-1,1]).range([d3.rgb("#FFC17A"), d3.rgb('#DE9FFF')]);

var y = d3.scaleBand().range([height, 0]).padding(0.1);


var dataSort = ((error) => {
  if (error) throw error;
  x.domain(d3.extent(data.all,(d)=>{return d.annual_growth;}));
  y.domain(data.all.map((d)=>{return d.country;}));

  var max = d3.max(data.all,(d)=>{return d.annual_growth;});
  colour.domain([-max, max]);

  var xAxis = svg
    .append("g")
    .attr("class", "x-axis")
    .attr("transform", "translate(0," + (height + cfg.xAxisMargin) + ")")
    .call(d3.axisBottom(x).tickSizeOuter(0));

  var div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

  var bars = svg.append("g").attr("class", "bars");
  bars.selectAll("rect")
    .data(data.all)
    .enter()
    .append("rect")
    .attr("class", "annual-growth")
    .on("mouseover", function(d) {
      div.transition().duration(200).style("opacity", .9);    
      div .html( 'Damage given: '+d.damage_given+' | '+'Damage taken: '+d.damage_taken +' | '+'Net Damage: '+d.annual_growth)
          .style("left", (d3.event.pageX) + "px")   
          .style("top", (d3.event.pageY - 28) + "px");
    })          
    .on("mouseout", function(d) {
      div.transition()
         .duration(500)
         .style("opacity", 0);
    })
    .attr("x", function(d) {return x(Math.min(0, d.annual_growth));})
    .attr("y", function(d) {return y(d.country);})
    .attr("height", y.bandwidth())
    .attr("width", function(d) {return Math.abs(x(d.annual_growth) - x(0));})
    .style("fill", function(d) {return colour(d.annual_growth);});
  
  bars.on("mouseover", function(d) {
    bars.selectAll("rect").style("filter", "grayscale(100%)")
    d3.select(this).style("filter", "grayscale(0%)")
  })
  .on("mouseout", function(d) {
    bars.selectAll("rect").style("filter", "grayscale(0%)")
  })

  var yAxis = svg.append("g")
    .attr("class", "y-axis")
    .attr("transform", "translate(" + x(0) + ",0)")
    .append("line")
    .attr("y1", 0)
    .attr("y2", height);
  
  var labels = svg.append("g").attr("class", "labels");
  labels.selectAll("text")
    .data(data.all)
    .enter()
    .append("text")
    .attr("class", "bar-label")
    .attr("x", x(0))
    .attr("y", function(d) {return y(d.country);})
    .attr("dx", function(d) {return d.annual_growth < 0 ? cfg.labelMargin : -cfg.labelMargin;})
    .attr("dy", y.bandwidth())
    .attr("text-anchor", function(d) {return d.annual_growth < 0 ? "start" : "end";})
    .text(function(d) {return d.country;})
  })()
}

  
  </script>
</body>
</html>